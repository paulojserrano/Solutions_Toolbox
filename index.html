<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Layout Builder</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="src/css/style.css">
</head>
<body class="bg-slate-50 min-h-screen flex flex-col font-sans">

    <header class="bg-white text-slate-900 shadow-sm border-b border-slate-200 z-10">
        <div class="w-full max-w-screen-2xl mx-auto p-4 md:p-6 flex items-center gap-4">
            <svg class="h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21 7.5l-9-5.25L3 7.5m18 0l-9 5.25L3 7.5m18 0v9l-9 5.25L3 16.5v-9m9 5.25v9l-9-5.25m9 5.25v-9l9-5.25" />
            </svg>
            <h1 class="text-xl md:text-2xl font-bold">
                Layout Builder
            </h1>
        </div>
    </header>

    <!-- Main Content Area (now a flex column) -->
    <main class="flex-1 w-full max-w-screen-2xl mx-auto p-4 md:p-6 flex flex-col gap-6">

        <!-- 1. NEW Main Tab Navigation (Solver is default) -->
        <nav class="bg-white rounded-lg shadow-lg -mb-2">
            <div class="border-b border-slate-200 overflow-x-auto" id="mainViewTabs">
                <div class="flex">
                    <button class="main-tab-button active" data-tab="solverTabContent">Solver</button>
                    <button class="main-tab-button" data-tab="configTabContent">Configuration</button>
                    <!-- NEW: Comparison Tab -->
                    <button id="comparisonTabButton" class="main-tab-button disabled" data-tab="comparisonTabContent" disabled>Comparison</button>
                </div>
            </div>
        </nav>

        <!-- 2. Main Tab Content: Solver (Active by default) -->
        <div id="solverTabContent" class="main-tab-content active">
            
            <!-- Top Row: Box 1 (Inputs) & Box 2 (Results) -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                
                <!-- Box 1: Inputs -->
                <section class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold text-slate-900 border-b border-slate-300 pb-3 mb-5">
                        1. Requirements
                    </h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2">
                        
                        <!-- Col 1: Warehouse Constraints (GLOBAL) -->
                        <div class="space-y-5">
                            <h3 class="text-base font-semibold text-slate-900 -mb-1">Warehouse</h3>
                            <div>
                                <label for="systemLength" class="block text-sm font-medium text-slate-700 mb-1">Length (mm)</label>
                                <input type="text" id="systemLength" value="30,000" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="systemWidth" class="block text-sm font-medium text-slate-700 mb-1">Width (mm)</label>
                                <input type="text" id="systemWidth" value="25,000" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="clearHeight" class="block text-sm font-medium text-slate-700 mb-1">Clear Height (mm)</label>
                                <input type="text" id="clearHeight" value="10,000" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <p class="helper-text">For elevation view</p>
                            </div>
                        </div>

                        <!-- Col 2: Solver Inputs (EXISTING) -->
                        <div class="space-y-5">
                            <h3 class="text-base font-semibold text-slate-900 -mb-1">Solver</h3>
                            <div>
                                <label for="solverConfigSelect" class="block text-sm font-medium text-slate-700 mb-1">Configuration</label>
                                <select id="solverConfigSelect" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                    <!-- Options populated by app.js -->
                                </select>
                                <p class="helper-text">Uses parameters from Configuration tab.</p>
                            </div>
                            <div>
                                <label for="solverStorageReq" class="block text-sm font-medium text-slate-700 mb-1">Storage Requirement (Locations)</label>
                                <input type="text" id="solverStorageReq" value="30,000" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="solverThroughputReq" class="block text-sm font-medium text-slate-700 mb-1">Throughput Requirement (Total PPH)</label>
                                <input type="text" id="solverThroughputReq" value="2,000" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="solverAspectRatio" class="block text-sm font-medium text-slate-700 mb-1">Aspect Ratio (L / W)</label>
                                <input type="text" id="solverAspectRatio" value="1.0" class="w-full rounded-md border-slate-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                                <p class="helper-text">e.g., 1.5 for (L = 1.5 * W)</p>
                            </div>
                        </div>
                        
                    </div>
                    <div class="mt-6">
                        <button id="runSolverButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 disabled:opacity-50">
                            Run Solver
                        </button>
                        <p id="solverStatus" class="text-center text-slate-600 mt-3 h-5"></p>
                    </div>
                </section>

                <!-- Box 2: Results -->
                <!-- MODIFIED: Grid layout changed to 3 cols -->
                <section class="bg-white p-6 rounded-lg shadow-lg">
                    <h2 class="text-lg font-semibold text-slate-900 border-b border-slate-300 pb-3 mb-5">
                        2. Results
                    </h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-x-4 gap-y-6">
                        <!-- Row 1 -->
                        <div>
                            <span class="block text-sm font-medium text-slate-500">Solved Length (mm)</span>
                            <span id="solverResultLength" class="text-2xl font-bold text-blue-600">0</span>
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-slate-500">Solved Width (mm)</span>
                            <span id="solverResultWidth" class="text-2xl font-bold text-blue-600">0</span>
                        </div>
                        <div>
                            <span class="block text-sm font-medium text-slate-500">Footprint (m²)</span>
                            <span id="solverResultFootprint" class="text-2xl font-bold text-blue-600">0</span>
                        </div>
                        
                        <!-- Row 2 -->
                        <div>
                            <span class="block text-sm font-medium text-slate-500">Locations</span>
                            <span id="solverResultLocations" class="text-2xl font-bold text-blue-600">0</span>
                        </div>
                        <!-- NEW: Gross Storage Volume -->
                        <div>
                            <span class="block text-sm font-medium text-slate-500">Gross Volume (m³)</span>
                            <span id="solverResultGrossVolume" class="text-2xl font-bold text-blue-600">0.0</span>
                        </div>
                        <!-- NEW: Total Bays -->
                        <div>
                            <span class="block text-sm font-medium text-slate-500">Total Bays</span>
                            <span id="solverResultTotalBays" class="text-2xl font-bold text-blue-600">0</span>
                        </div>

                        <!-- Row 3 -->
                        <div>
                            <span class="block text-sm font-medium text-slate-500">Perf. Density</span>
                            <span id="solverResultPerfDensity" class="text-2xl font-bold text-blue-600">0.0</span>
                        </div>
                        <!-- NEW: Capacity Utilization -->
                        <div>
                            <span class="block text-sm font-medium text-slate-500">Cap. Utilization</span>
                            <span id="solverResultCapacityUtil" class="text-2xl font-bold text-blue-600">0.0 %</span>
                        </div>
                        <!-- NEW: Rows x Bays/Row -->
                        <div>
                            <span class="block text-sm font-medium text-slate-500">Rows x Bays/Row</span>
                            <span id="solverResultRowsAndBays" class="text-2xl font-bold text-blue-600">0 x 0</span>
                        </div>
                    </div>
                    <!-- MODIFIED: Removed button grid, export button is now full width -->
                    <div class="mt-6">
                         <!-- REMOVED Apply Solver Button -->
                         <!-- NEW: Export JSON Button -->
                         <button id="exportResultsButton" class="w-full bg-slate-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-opacity-75" style="display: none;">
                            Export JSON
                        </button>
                    </div>

                    <!-- MOVED: Layout Metrics Table -->
                    <h2 class="text-lg font-semibold text-slate-900 border-b border-slate-300 pb-3 mb-4 mt-8">
                        Layout Metrics
                    </h2>
                    <div class="space-y-4">
                        <!-- NEW TABLE STRUCTURE -->
                        <table class="metric-table">
                            <thead>
                                <tr>
                                    <th>Bay Type</th>
                                    <th>Locs / Level</th>
                                    <th>Levels</th>
                                    <th>Num. Bays</th>
                                    <th class="total-col">Total Locs</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Standard</td>
                                    <td><span id="metric-std-locs-lvl">0</span></td>
                                    <td><span id="metric-std-levels">0</span></td>
                                    <td><span id="metric-std-bays">0</span></td>
                                    <td class="total-col"><span id="metric-std-locs-total">0</span></td>
                                </tr>
                                <tr>
                                    <td>Backpack</td>
                                    <td><span id="metric-bp-locs-lvl">0</span></td>
                                    <td><span id="metric-bp-levels">0</span></td>
                                    <td><span id="metric-bp-bays">0</span></td>
                                    <td class="total-col"><span id="metric-bp-locs-total">0</span></td>
                                </tr>
                                <tr>
                                    <td>Tunnel</td>
                                    <td><span id="metric-tun-locs-lvl">0</span></td>
                                    <td><span id="metric-tun-levels">0</span></td>
                                    <td><span id="metric-tun-bays">0</span></td>
                                    <td class="total-col"><span id="metric-tun-locs-total">0</span></td>
                                </tr>
                                 <tr class="total-row">
                                    <td class="font-bold">Total</td>
                                    <td class="total-col">—</td>
                                    <td class="total-col">—</td>
                                    <td class="total-col"><span id="metric-tot-bays">0</span></td>
                                    <td class="total-col"><span id="metric-tot-locs-total">0</span></td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- END: Layout Metrics Table -->
                    </div>

                </section>

            </div>

            <!-- Bottom Row: Box 3 (Visualizations) -->
            <section class="bg-white p-6 rounded-lg shadow-lg flex-1 flex flex-col overflow-hidden">
                <div class="flex justify-between items-center pb-3 mb-4 border-b border-slate-300">
                    <h2 class="text-lg font-semibold text-slate-900">
                        3. Visualizations
                    </h2>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="detailViewToggle" class="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500">
                        <label for="detailViewToggle" class="text-sm font-medium text-slate-700">Show Detail View</label>
                    </div>
                </div>

                <!-- MODIFIED: Visualization Layout -->
                <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-4 overflow-hidden">
            
                    <!-- Row 1: Top-Down View (Full Width) -->
                    <div class="flex flex-col h-full bg-slate-50 rounded-md overflow-hidden border border-slate-200 lg:col-span-2 lg:row-span-1">
                        <h3 class="text-sm font-semibold text-slate-700 bg-slate-100 px-3 py-2 border-b border-slate-200">
                            Top-Down View
                        </h3>
                        <div class="flex-1 w-full h-full overflow-hidden relative">
                            <canvas id="warehouseCanvas"></canvas>
                        </div>
                    </div>
                    
                    <!-- Row 2, Col 1: Elevation View (Half Width) -->
                    <div class="flex flex-col h-full bg-slate-50 rounded-md overflow-hidden border border-slate-200 lg:col-span-1 lg:row-span-1">
                        <h3 class="text-sm font-semibold text-slate-700 bg-slate-100 px-3 py-2 border-b border-slate-200">
                            Elevation View
                        </h3>
                        <div class="flex-1 w-full h-full overflow-hidden relative">
                             <canvas id="elevationCanvas"></canvas>
                        </div>
                    </div>
    
                    <!-- Row 2, Col 2: Rack Detail View (Half Width) -->
                    <div class="flex flex-col h-full bg-slate-50 rounded-md overflow-hidden border border-slate-200 lg:col-span-1 lg:row-span-1">
                         <h3 class="text-sm font-semibold text-slate-700 bg-slate-100 px-3 py-2 border-b border-slate-200">
                            Rack Detail View
                        </h3>
                        <div class="flex-1 w-full h-full overflow-hidden relative">
                             <canvas id="rackDetailCanvas"></canvas>
                        </div>
                    </div>
                
                </div>

            </section>
            
        </div>

        <!-- 3. Main Tab Content: Configuration (scrolls) -->
        <div id="configTabContent" class="main-tab-content space-y-6 overflow-y-auto">
            
            <h2 class="text-xl font-semibold text-slate-900 px-1 pt-2">
                Available System Configurations
            </h2>
            <p class="text-slate-600 -mt-4 px-1">
                These are the read-only parameter sets used by the solver.
            </p>

            <div id="readOnlyConfigContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Config cards will be injected here -->
            </div>

        </div>
        
        <!-- 4. NEW Main Tab Content: Comparison -->
        <div id="comparisonTabContent" class="main-tab-content space-y-6 overflow-y-auto">
            
            <!-- Button Container -->
            <section id="runAllOptionsContainer" class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-lg font-semibold text-slate-900 border-b border-slate-300 pb-3 mb-5">
                    Run All Configurations
                </h2>
                <p class="text-slate-600 mb-4">
                    Click the button below to run the solver against all available configurations using the same inputs from the "Solver" tab. This may take a moment.
                </p>
                <button id="runAllOptionsButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 disabled:opacity-50">
                    Run All Options
                </button>
                <p id="runAllStatus" class="text-center text-slate-600 mt-3 h-5"></p>
            </section>

            <!-- Results Grid -->
            <section>
                <h2 class="text-xl font-semibold text-slate-900 px-1 pt-2">
                    Comparison Results
                </h2>
                <div id="comparisonResultsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-4">
                    <!-- Result cards will be injected here by solver.js -->
                    <p class="text-slate-500 col-span-full">Run the comparison to see results.</p>
                </div>
            </section>
            
        </div>

    </main>

    <!-- Solver Modal -->
    <div id="solverModal" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="absolute inset-0" id="solverModalBackdrop"></div>
        <div class="relative bg-white w-full max-w-lg p-6 rounded-lg shadow-xl">
            <h3 class="text-xl font-semibold text-slate-900 mb-4">Solver Warning</h3>
            <p id="solverModalMessage" class="text-slate-600 mb-6">
                <!-- Message injected by JS -->
            </p>
            <div class="flex justify-end gap-4">
                <button id="solverModalStop" class="px-6 py-2 rounded-lg bg-slate-200 text-slate-800 font-medium hover:bg-slate-300">
                    No, Use Current Size
                </button>
                <button id="solverModalContinue" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-700">
                    Yes, Continue
                </button>
            </div>
        </div>
    </div>


    <!-- JavaScript -->
    <script type="module" src="src/js/app.js"></script>
</body>
</html>